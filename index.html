<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freeper Portfolio | Admin</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        @font-face { font-family: 'Minecraft'; src: url('MinecraftRegular-Bmg3.otf'); }
        body { font-family: 'Minecraft', sans-serif; background: #fff; text-align: center; margin: 0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px; }
        .card { border: 4px solid #eee; padding: 10px; cursor: pointer; transition: 0.2s; }
        .card:hover { border-color: #333; }
        .card img { width: 100%; height: 200px; object-fit: cover; }
        
        /* Admin Dashboard */
        #admin-dashboard { display: none; background: #f9f9f9; border-bottom: 4px solid #5865F2; padding: 30px; }
        .admin-tool { background: white; border: 3px solid #333; padding: 15px; margin: 10px auto; max-width: 600px; }
        .drop-zone { border: 2px dashed #ccc; padding: 20px; margin: 10px 0; cursor: pointer; }
        .drop-zone.hover { background: #e1e4ff; border-color: #5865F2; }
        
        #admin-login-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center; }
        .btn { background: #333; color: white; border: none; padding: 10px 20px; font-family: 'Minecraft'; cursor: pointer; }
        .btn-red { background: #ff4747; }
    </style>
</head>
<body>

<div id="admin-login-overlay">
    <div style="background:white; padding:30px; border:4px solid #333;">
        <h2>ADMIN LOGIN</h2>
        <input type="text" id="admin-user" placeholder="User"><br><br>
        <input type="password" id="admin-pass" placeholder="Pass"><br><br>
        <button class="btn" onclick="checkAdmin()">LOGIN</button>
    </div>
</div>

<div id="admin-dashboard">
    <h2>DASHBOARD</h2>
    <div class="admin-tool">
        <h3>Neues Projekt</h3>
        <input type="text" id="new-proj-name" placeholder="Projekt Name">
        <button class="btn" onclick="createProject()">ORDNER ERSTELLEN</button>
    </div>
    <div id="active-edit-zone" style="display:none;" class="admin-tool">
        <h3 id="edit-folder-name">Editiere: -</h3>
        <div class="drop-zone" id="drop-start">Startbild hierher ziehen</div>
        <div class="drop-zone" id="drop-gallery">Galeriebilder hierher ziehen</div>
        <button class="btn" onclick="finishEdit()">FERTIG</button>
    </div>
    <button class="btn btn-red" onclick="location.reload()">LOGOUT</button>
</div>

<header style="padding:50px;">
    <h1>Freeper Portfolio</h1>
    <p>Drücke "A" "D" "M" "I" "N" zum Einloggen</p>
</header>

<div class="grid" id="main-grid"></div>

<script>
let projects = [];
let currentEditFolder = "";
let keyLog = "";

// Admin Trigger
document.addEventListener('keydown', (e) => {
    keyLog += e.key.toUpperCase();
    if (keyLog.includes("ADMIN")) {
        document.getElementById('admin-login-overlay').style.display = 'flex';
        keyLog = "";
    }
});

async function checkAdmin() {
    const user = document.getElementById('admin-user').value;
    const pass = document.getElementById('admin-pass').value;
    const res = await fetch('/api/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user, pass})
    });
    if (res.ok) {
        document.getElementById('admin-login-overlay').style.display = 'none';
        document.getElementById('admin-dashboard').style.display = 'block';
        loadProjects();
    } else alert("Falsch!");
}

async function loadProjects() {
    const res = await fetch('/api/projects');
    projects = await res.json();
    const grid = document.getElementById('main-grid');
    grid.innerHTML = '';
    projects.forEach(p => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
            <img src="${p.cover || 'placeholder.png'}">
            <p>${p.name}</p>
            ${document.getElementById('admin-dashboard').style.display === 'block' ? 
                `<button class="btn" onclick="startEdit('${p.folder}')">EDIT</button> 
                 <button class="btn btn-red" onclick="deleteProject('${p.folder}')">X</button>` : ''}
        `;
        grid.appendChild(div);
    });
}

async function createProject() {
    const name = document.getElementById('new-proj-name').value;
    const res = await fetch('/api/projects/create', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name})
    });
    const data = await res.json();
    if (res.ok) startEdit(data.folder);
}

function startEdit(folder) {
    currentEditFolder = folder;
    document.getElementById('active-edit-zone').style.display = 'block';
    document.getElementById('edit-folder-name').innerText = "Editiere: " + folder;
    window.scrollTo(0,0);
}

async function deleteProject(folder) {
    if (confirm("Löschen?")) {
        await fetch(`/api/projects/${folder}`, { method: 'DELETE' });
        loadProjects();
    }
}

// Drag & Drop Handling
function setupDropZone(id, type) {
    const zone = document.getElementById(id);
    zone.ondragover = (e) => { e.preventDefault(); zone.classList.add('hover'); };
    zone.ondragleave = () => zone.classList.remove('hover');
    zone.ondrop = async (e) => {
        e.preventDefault();
        zone.classList.remove('hover');
        const files = e.dataTransfer.files;
        for (let i = 0; i < files.length; i++) {
            const formData = new FormData();
            formData.append('image', files[i]);
            formData.append('folder', currentEditFolder);
            formData.append('type', type);
            formData.append('index', i);
            await fetch('/api/upload', { method: 'POST', body: formData });
        }
        alert("Hochgeladen!");
        loadProjects();
    };
}

setupDropZone('drop-start', 'start');
setupDropZone('drop-gallery', 'gallery');

function finishEdit() {
    document.getElementById('active-edit-zone').style.display = 'none';
    currentEditFolder = "";
    loadProjects();
}

loadProjects();
</script>
</body>
</html>