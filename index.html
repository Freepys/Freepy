<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freepy's Building Portfolio</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        @font-face { font-family: 'Minecraft'; src: url('MinecraftRegular-Bmg3.otf'); }
        @font-face { font-family: 'MinecraftBold'; src: url('MinecraftBold-nMK1.otf'); font-weight: bold; }
        
        * { 
            font-family: 'Minecraft', sans-serif !important; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }
        
        h1, h2, h3, .card-title, .btn { 
            font-family: 'MinecraftBold', sans-serif !important; 
        }

        body { 
            margin: 0; 
            background: #fff; 
            text-align: center; 
            color: #333; 
            overflow-x: hidden;
        }

        /* Clean Loading Animation */
        .fade-in { 
            animation: fadeIn 0.4s ease-out forwards; 
            opacity: 0; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* Admin Bar */
        #admin-bar { 
            display: none; 
            background: #5865F2; 
            color: white; 
            padding: 15px; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        header { padding: 80px 20px 40px; }
        h1 { font-size: 3.2rem; margin: 0; letter-spacing: -1px; }
        .subtitle { color: #aaa; font-size: 1.1rem; margin-top: 10px; }

        .container { 
            max-width: 1300px; 
            margin: 0 auto; 
            padding: 20px; 
        }

        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 30px; 
        }

        /* Projekt & Bild Karten */
        .card { 
            border: 4px solid #f2f2f2; 
            background: #fff; 
            cursor: pointer; 
            position: relative; 
            transition: transform 0.2s, border-color 0.2s;
            overflow: hidden;
        }
        .card:hover { 
            border-color: #333; 
            transform: translateY(-5px); 
        }
        .card img { 
            width: 100%; 
            height: 240px; 
            object-fit: cover; 
            display: block; 
            pointer-events: none; /* Verhindert Probleme beim Draggen */
        }
        .card-title { 
            padding: 15px; 
            font-size: 0.9rem; 
            border-top: 4px solid #f2f2f2;
            text-transform: uppercase;
        }

        /* Admin Mode Styling */
        .admin-active .card { 
            cursor: grab; 
            border: 4px solid #5865F2; 
        }
        .admin-active .card:active { 
            cursor: grabbing; 
        }
        .sortable-ghost { 
            opacity: 0.2; 
            transform: scale(0.9); 
        }

        /* Buttons */
        .btn { 
            padding: 10px 20px; 
            background: #333; 
            color: #fff; 
            border: 4px solid #000; 
            cursor: pointer; 
            margin: 5px; 
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        .btn:hover { background: #555; }
        .btn-save { background: #fff; color: #5865F2; border-color: #fff; }

        /* Drag & Drop Overlay */
        #drop-overlay { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(88, 101, 242, 0.9); 
            z-index: 5000; 
            border: 10px dashed #fff; 
            align-items: center; 
            justify-content: center; 
            color: #fff; 
            font-size: 2rem; 
            pointer-events: none;
        }

        footer { 
            margin: 100px 0 50px; 
            color: #bbb; 
            font-size: 0.9rem; 
        }

        #back-btn { display: none; margin-bottom: 40px; }
    </style>
</head>
<body ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">

    <div id="drop-overlay">DROP IMAGES TO UPLOAD TO THIS PROJECT</div>

    <div id="admin-bar">
        ADMIN MODE ACTIVE — Hold & Drag to reorder
        <button class="btn btn-save" onclick="saveAll()">SAVE TO GITHUB</button>
        <button class="btn" style="background:red; border-color:red;" onclick="location.reload()">LOGOUT</button>
    </div>

    <header id="main-header">
        <h1>Freepy's building portfolio</h1>
        <p class="subtitle">inspired by SmokePVP</p>
    </header>

    <div class="container">
        <button id="back-btn" class="btn" onclick="showCats()">← BACK TO CATEGORIES</button>
        <div id="view" class="grid"></div>
    </div>

    <footer>
        Made by Freepy
    </footer>

    <script>
        let projects = [];
        let currentProjIdx = null;
        let loggedIn = false;
        let sortableInstance = null;

        // Projekte beim Start laden
        async function load() {
            try {
                const res = await fetch('/api/projects');
                projects = await res.json();
                render();
            } catch (err) {
                console.error("Failed to load projects:", err);
            }
        }

        function render() {
            const view = document.getElementById('view');
            view.innerHTML = '';
            
            if (currentProjIdx === null) {
                // KATEGORIE ANSICHT
                projects.forEach((p, i) => {
                    const card = document.createElement('div');
                    card.className = 'card fade-in';
                    card.style.animationDelay = (i * 0.05) + 's';
                    card.innerHTML = `
                        <img src="${p.cover || 'placeholder.jpg'}">
                        <div class="card-title">${p.name}</div>
                    `;
                    card.onclick = () => { if(!loggedIn) showGal(i); };
                    view.appendChild(card);
                });
            } else {
                // GALERIE ANSICHT
                const p = projects[currentProjIdx];
                p.images.forEach((img, i) => {
                    const card = document.createElement('div');
                    card.className = 'card fade-in';
                    card.style.animationDelay = (i * 0.05) + 's';
                    card.innerHTML = `<img src="${img}">`;
                    view.appendChild(card);
                });
            }
            
            if(loggedIn) setupSorting();
        }

        function setupSorting() {
            if(sortableInstance) sortableInstance.destroy();
            
            const el = document.getElementById('view');
            sortableInstance = new Sortable(el, {
                animation: 250,
                ghostClass: 'sortable-ghost',
                delay: 200, // Langes Drücken für Drag
                delayOnTouchOnly: true,
                onEnd: (evt) => {
                    if (currentProjIdx === null) {
                        // Kategorien sortieren
                        const item = projects.splice(evt.oldIndex, 1)[0];
                        projects.splice(evt.newIndex, 0, item);
                    } else {
                        // Bilder innerhalb eines Projekts sortieren
                        const imgs = projects[currentProjIdx].images;
                        const item = imgs.splice(evt.oldIndex, 1)[0];
                        imgs.splice(evt.newIndex, 0, item);
                    }
                }
            });
        }

        function showGal(i) {
            currentProjIdx = i;
            document.getElementById('back-btn').style.display = 'inline-block';
            document.getElementById('main-header').style.display = 'none';
            render();
            window.scrollTo(0,0);
        }

        function showCats() {
            currentProjIdx = null;
            document.getElementById('back-btn').style.display = 'none';
            document.getElementById('main-header').style.display = 'block';
            render();
            window.scrollTo(0,0);
        }

        async function saveAll() {
            const btn = document.querySelector('.btn-save');
            btn.innerText = "SAVING...";
            
            const res = await fetch('/api/projects/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(projects)
            });
            
            if(res.ok) {
                alert("Changes saved and synced to GitHub!");
            } else {
                alert("Error saving changes.");
            }
            btn.innerText = "SAVE TO GITHUB";
        }

        // Drag & Drop Upload Logik
        function handleDragOver(e) {
            if(loggedIn && currentProjIdx !== null) {
                e.preventDefault();
                document.getElementById('drop-overlay').style.display = 'flex';
            }
        }

        function handleDragLeave(e) {
            document.getElementById('drop-overlay').style.display = 'none';
        }

        async function handleDrop(e) {
            if(!loggedIn || currentProjIdx === null) return;
            e.preventDefault();
            document.getElementById('drop-overlay').style.display = 'none';
            
            const files = e.dataTransfer.files;
            if(files.length === 0) return;

            for(let f of files) {
                const fd = new FormData();
                fd.append('file', f);
                fd.append('folder', projects[currentProjIdx].folder);
                await fetch('/api/upload', { method: 'POST', body: fd });
            }
            
            alert("Upload successful! Refreshing...");
            load();
        }

        // Admin Secret Trigger: Tippe "ADMIN" auf der Tastatur
        let keys = "";
        document.addEventListener('keydown', async e => {
            keys += e.key.toUpperCase();
            if(keys.includes("ADMIN")) {
                const pass = prompt("Enter Admin Password:");
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user: "Admin Freeperr", pass})
                });

                if(res.ok) {
                    loggedIn = true;
                    document.body.classList.add('admin-active');
                    document.getElementById('admin-bar').style.display = 'block';
                    render();
                } else {
                    alert("Wrong password.");
                }
                keys = "";
            }
        });

        // Initialer Load
        load();
    </script>
</body>
</html>